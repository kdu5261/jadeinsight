/***************************************
 * JADE INSIGHT - Web App
 * Landing -> Apps Script WebApp -> Google Sheets
 * + Telegram instant notification
 ***************************************/

// âœ… ë³€ê²½: ì €ì¥ë  êµ¬ê¸€ì‹œíŠ¸ IDë¥¼ ìƒˆ ê²ƒìœ¼ë¡œ êµì²´ (ë‹¤ë¥¸ ê±´ ì „ë¶€ ê·¸ëŒ€ë¡œ)
const SPREADSHEET_ID = "11nB37AAhupciw_0R9NCKKUejaTMZ9hgKjEli3euRsas";
const SHEET_NAME = "leads";

// âš ï¸ ë³´ì•ˆìƒ í† í°ì€ ëŒ€í™”ì— ë…¸ì¶œë¨. ë¬¸ì œ í•´ê²° í›„ BotFather /revokeë¡œ ì¬ë°œê¸‰ ì¶”ì²œ
const TELEGRAM_BOT_TOKEN = "8586547740:AAGU6UvLaTckScWjTIXBeUi08baiNKw0-U8";
const TELEGRAM_CHAT_ID = "5176383877";

// âœ… ë°°í¬ ë²„ì „/ì½”ë“œ ì ìš© í™•ì¸ìš©(ì„ì˜ë¡œ ìˆ«ì ì˜¬ë¦¬ë©´ doGet ì‘ë‹µì´ ë°”ë€œ)
const BUILD_TAG = "v-current-1";

/**
 * ë¸Œë¼ìš°ì €ì—ì„œ ì›¹ì•± URL ì—´ì—ˆì„ ë•Œ ì •ìƒ ë™ì‘/ë²„ì „ í™•ì¸
 */
function doGet() {
  return ContentService
    .createTextOutput(`JadeInsight WebApp is running | ${BUILD_TAG}`)
    .setMimeType(ContentService.MimeType.TEXT);
}

/**
 * Landing form submit (POST)
 * Supports:
 * - form-urlencoded (e.parameter)
 * - JSON (e.postData.contents)
 *
 * Expected field keys:
 * company, industry, sales, source, location, name, phone
 */
function doPost(e) {
  const sheet = getSheet_();

  // 1) ê¸°ë³¸: form-urlencoded
  let data = (e && e.parameter) ? e.parameter : {};

  // 2) JSON payload ë³‘í•©
  try {
    if (e && e.postData && e.postData.contents) {
      const contentType = (e.postData.type || "").toLowerCase();
      if (contentType.includes("application/json")) {
        const json = JSON.parse(e.postData.contents);
        data = { ...data, ...json };
      }
    }
  } catch (err) {
    Logger.log("JSON parse error: " + err);
  }

  // âœ… ì‹œíŠ¸ ì €ì¥ (ë¨¼ì € ì €ì¥í•´ì„œ ëˆ„ë½ ë°©ì§€)
  sheet.appendRow([
    data.company || "",
    data.industry || "",
    data.sales || "",
    data.source || "",
    data.location || "",
    data.name || "",
    data.phone || "",
    new Date()
  ]);

  // âœ… í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ êµ¬ì„±
  const message =
    `âœ… ìƒˆ ìƒë‹´ ì‹ ì²­ ì ‘ìˆ˜\n\n` +
    `ğŸ¢ ìƒí˜¸ëª…: ${data.company || "-"}\n` +
    `ğŸ“Œ ì—…ì¢…: ${data.industry || "-"}\n` +
    `ğŸ’° ë§¤ì¶œ: ${data.sales || "-"}\n` +
    `ğŸ“£ ìœ ì…ê²½ë¡œ: ${data.source || "-"}\n` +
    `ğŸ“ ì§€ì—­: ${data.location || "-"}\n` +
    `ğŸ‘¤ ì´ë¦„: ${data.name || "-"}\n` +
    `ğŸ“ ì—°ë½ì²˜: ${data.phone || "-"}\n\n` +
    `â° ${new Date().toLocaleString("ko-KR")}\n` +
    `ğŸ§© Build: ${BUILD_TAG}`;

  // âœ… í…”ë ˆê·¸ë¨ ì „ì†¡ (ì‹¤íŒ¨í•´ë„ í¼ íë¦„ ìœ ì§€, ëŒ€ì‹  ë¡œê·¸ì— ì´ìœ  ë‚¨ê¹€)
  try {
    const result = sendTelegram_(message);
    Logger.log("Telegram result: " + JSON.stringify(result));
  } catch (err) {
    Logger.log("Telegram ERROR: " + err);
  }

  return ContentService
    .createTextOutput("success")
    .setMimeType(ContentService.MimeType.TEXT);
}

/**
 * Telegram send (debug logs)
 */
function sendTelegram_(text) {
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  const payload = { chat_id: TELEGRAM_CHAT_ID, text: text };

  const res = UrlFetchApp.fetch(url, {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  });

  const code = res.getResponseCode();
  const body = res.getContentText();
  Logger.log("Telegram status: " + code);
  Logger.log("Telegram body: " + body);

  let parsed = null;
  try { parsed = JSON.parse(body); } catch (e) {}

  if (code !== 200 || (parsed && parsed.ok === false)) {
    throw new Error(`Telegram failed. status=${code} body=${body}`);
  }

  return parsed || { status: code, body: body };
}

/**
 * Get target sheet
 */
function getSheet_() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) throw new Error(`Sheet not found: ${SHEET_NAME}`);
  return sheet;
}

/**
 * âœ… í…ŒìŠ¤íŠ¸ 1: í…”ë ˆê·¸ë¨ë§Œ
 */
function testTelegram() {
  sendTelegram_(`âœ… [í…ŒìŠ¤íŠ¸] í…”ë ˆê·¸ë¨ ì•Œë¦¼ í…ŒìŠ¤íŠ¸\nBuild: ${BUILD_TAG}`);
}

/**
 * âœ… í…ŒìŠ¤íŠ¸ 2: ì‹œíŠ¸ ì €ì¥ + í…”ë ˆê·¸ë¨
 */
function testWriteAndNotify() {
  const sheet = getSheet_();
  sheet.appendRow(["í…ŒìŠ¤íŠ¸ìƒí˜¸", "í…ŒìŠ¤íŠ¸ì—…ì¢…", "1ì–µ ë¯¸ë§Œ", "ìœ íŠœë¸Œ", "ì„œìš¸", "í™ê¸¸ë™", "010-0000-0000", new Date()]);
  sendTelegram_(`âœ… [í…ŒìŠ¤íŠ¸] ì‹œíŠ¸ ì €ì¥ + í…”ë ˆê·¸ë¨ OK\nBuild: ${BUILD_TAG}`);
}

/**
 * âœ… ë””ë²„ê·¸: ë´‡ì´ ì¸ì‹í•œ chat_id í™•ì¸
 * (ë´‡ì—ê²Œ ë©”ì‹œì§€ 1ê°œ ë³´ë‚´ê³  ì‹¤í–‰)
 */
function debugGetUpdates() {
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates`;
  const res = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
  Logger.log(res.getContentText());
}

/**
 * âœ… ë””ë²„ê·¸: í† í° ìœ íš¨ì„± í™•ì¸
 */
function testGetMe() {
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe`;
  const res = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
  Logger.log(res.getContentText());
}
